{{ define "main" }}
{{ $h  := .Site.Params.hero }}
{{ $sv := .Site.Params.services }}
{{ $heroStyle := "" }}
{{ with $h.backgroundImage }}
  {{ $bg := . }}
  {{ if or (hasPrefix $bg "http://") (hasPrefix $bg "https://") }}
    {{ $heroStyle = printf "--hero-bg-image: url('%s');" ($bg | safeURL) }}
  {{ else }}
    {{ $heroStyle = printf "--hero-bg-image: url('%s');" ($bg | relURL | safeURL) }}
  {{ end }}
{{ end }}
{{ with $h.overlayColor }}
  {{ $heroStyle = printf "%s --hero-overlay: %s;" $heroStyle . }}
{{ end }}
{{ with $h.blur }}
  {{ $heroStyle = printf "%s --hero-blur: %s;" $heroStyle . }}
{{ end }}

<!-- ===== Hero Section ===== -->
<section class="hero"{{ with $heroStyle }} style="{{ . | safeCSS }}"{{ end }}>
  <div class="container">
    <h1>{{ or $h.title "Company Hero" }}</h1>

    {{ with (or $h.subtitle "What do we do?") }}
      <p>{{ . }}</p>
    {{ end }}

    {{ if or $h.primaryText $h.secondaryText }}
      <div class="hero-actions">
        {{ with $h.primaryText }}
          <a class="btn primary" href="{{ ($h.primaryHref | default "contact") | relURL }}">
            {{ . }}
          </a>
        {{ end }}
        {{ with $h.secondaryText }}
          <a class="btn" href="{{ ($h.secondaryHref | default "services") | relURL }}">
            {{ . }}
          </a>
        {{ end }}
      </div>
    {{ end }}
  </div>
</section>

<!-- ===== Featured Services (only if at least one resolves) ===== -->
{{ $featured := slice }}
{{ with $sv.featured }}
  {{ range . }}
    {{ $p := site.GetPage . | default (site.GetPage (printf "services/%s" .)) }}
    {{ with $p }}{{ $featured = $featured | append . }}{{ end }}
  {{ end }}
{{ end }}

{{ if gt (len $featured) 0 }}
<section class="section services"
         style="--service-img-width: {{ or $sv.serviceImageWidth "100%" }};">
  <div class="container">
    <div class="section-head">
      <h2>{{ with $sv.title }}{{ . }}{{ else }}Services{{ end }}</h2>
      {{ with $sv.intro }}<p class="muted">{{ . }}</p>{{ end }}
    </div>

    <div class="grid cols-3">
      {{ range $featured }}
        <article class="card">
        {{ with .Params.image }}
          {{ $img := . }}
          {{ if or (hasPrefix $img "http://") (hasPrefix $img "https://") }}
            <img src="{{ $img | safeURL }}" alt="{{ $.Title }}" class="service-image">
          {{ else }}
            <img src="{{ $img | relURL | safeURL }}" alt="{{ $.Title }}" class="service-image">
          {{ end }}
        {{ end }}

          <div class="card-content">
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
            {{ $fmSum := trim .Params.summary " \t\r\n" }}
            {{ $Sum := trim .Summary " \t\r\n" }}
            {{ $summary := or $fmSum $Sum }}
            <p class="muted card-summary">{{ $summary | plainify }}</p>
          </div>

          <div class="service-actions">
            <a class="btn" href="{{ .RelPermalink }}">Read more →</a>
          </div>
        </article>
      {{ end }}
    </div>

    <div class="service-actions" style="text-align:center; margin-top:2rem;">
      <a class="btn" href="{{ "services" | relURL }}">View all services →</a>
    </div>
  </div>
</section>
{{ end }}

<!-- ===== Blog Section (only if there are posts) ===== -->
{{ $posts := where .Site.RegularPages "Section" "blog" | first 3 }}

{{ if gt (len $posts) 0 }}
<section class="section blog">
  <div class="container">
    <div class="section-head">
      <h2>{{ with .Site.Params.blog.title }}{{ . }}{{ else }}Latest Blog Posts{{ end }}</h2>
      {{ with .Site.Params.blog.intro }}<p class="muted">{{ . }}</p>{{ end }}
    </div>

    <div class="grid cols-3">
      {{ range $posts }}
        <article class="card">
          <div class="card-content">
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
            {{ $fmSum := trim .Params.summary " \t\r\n" }}
            {{ $Sum := trim .Summary " \t\r\n" }}
            {{ $summary := or $fmSum $Sum }}
            <p class="muted card-summary">{{ $summary | plainify }}</p>
          </div>

          <div class="service-actions">
            <a class="btn" href="{{ .RelPermalink }}">Read more →</a>
          </div>
        </article>
      {{ end }}
    </div>

    <div class="blog-actions" style="text-align:center; margin-top:2rem;">
      <a class="btn" href="{{ "blog" | relURL }}">View all posts →</a>
    </div>
  </div>
</section>
{{ end }}

{{ end }}
